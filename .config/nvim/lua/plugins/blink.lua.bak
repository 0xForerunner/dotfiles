return {
  "Saghen/blink.cmp",
  optional = true,
  opts = function(_, opts)
    -- merge keymaps instead of replacing
    opts.keymap = vim.tbl_deep_extend("force", opts.keymap or {}, {
      ["<Tab>"] = {
        "snippet_forward",
        function()
          if vim.g.ai_accept then return vim.g.ai_accept() end
        end,
        "fallback",
      },
      ["<S-Tab>"] = { "snippet_backward", "fallback" },
      ["<A-y>"] = require("minuet").make_blink_map(),
    })

    -- ensure sub-tables exist
    opts.sources = opts.sources or {}
    opts.sources.default = opts.sources.default or { "lsp", "path", "buffer", "snippets" }
    opts.sources.providers = opts.sources.providers or {}

    -- add/merge the minuet provider (no overwrite)
    opts.sources.providers.minuet = vim.tbl_deep_extend("force", opts.sources.providers.minuet or {}, {
      name = "minuet",
      module = "minuet.blink",
      async = true,
      -- keep in sync with minuet.config.request_timeout * 1000
      timeout_ms = 3000,
      score_offset = 50,
    })

    -- include "minuet" in defaults if not already present
    local has_minuet = false
    for _, src in ipairs(opts.sources.default) do
      if src == "minuet" then
        has_minuet = true
        break
      end
    end
    if not has_minuet then table.insert(opts.sources.default, "minuet") end

    -- merge completion settings (donâ€™t replace the whole table)
    opts.completion = vim.tbl_deep_extend("force", opts.completion or {}, {
      trigger = { prefetch_on_insert = false },
    })
  end,
}
